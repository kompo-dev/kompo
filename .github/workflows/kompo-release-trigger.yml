name: Kompo Release Trigger

on:
  release:
    types: [published]

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare-version-bump:
    name: Prepare Version Bump
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Staging
        uses: actions/checkout@v4
        with:
          ref: staging
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js 24
        uses: actions/setup-node@v4
        with:
          node-version: 24.12.0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.1+sha512.7d7dbbca9e99447b7c3bf7a73286afaaf6be99251eb9498baefa7d406892f67b879adb3a1d7e687fc4ccc1a388c7175fbaae567a26ab44d1067b54fcb0d6a316

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Config Git User
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Apply Versioning (Changesets)
        run: |
          # Apply version bumps (updates package.json and consumes changesets)
          pnpm release:version
          
          # Check if we have changes
          if [ -z "$(git status --porcelain)" ]; then
            echo "::warning::No changes detected (no changesets?). Exiting."
            exit 0
          fi
          
          # Extract version for branch name
          VERSION=$(node -p "require('./packages/cli/package.json').version")
          BRANCH_NAME="chore/release-v$VERSION"
          
          echo "Preparing branch: $BRANCH_NAME"
          
          # Create temporary branch
          git checkout -b "$BRANCH_NAME"
          
          # Commit changes
          git add .
          git commit -m "chore: version packages v$VERSION"
          
          # Push branch (new branch, so allowed even if protected usually)
          git push origin "$BRANCH_NAME" --force
          
          # Set Output for next steps
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Create & Merge PR (to Staging)
        if: env.BRANCH_NAME != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_TITLE="chore: version packages v$VERSION"
          PR_BODY="Automated version bump triggered by Draft Release publish."
          
          echo "Creating PR from $BRANCH_NAME to staging..."
          
          # Create PR
          PR_URL=$(gh pr create \
            --base staging \
            --head "$BRANCH_NAME" \
            --title "$PR_TITLE" \
            --body "$PR_BODY")
            
          echo "PR Created: $PR_URL"
          
          # Enable Auto-Merge
          # This will invoke the Merge Queue if configured on staging
          gh pr merge "$PR_URL" --merge --auto
