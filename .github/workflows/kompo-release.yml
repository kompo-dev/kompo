name: Release
on:
  push:
    branches:
      - main
      - staging
  pull_request:
    branches:
      - main

concurrency: ${{ github.workflow }}-${{ github.ref }}

permissions:
  contents: write
  id-token: write
  pull-requests: write

jobs:
  validate-pr:
    name: Validate Release PR
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check for pending changesets
        run: |
          if [ -n "$(find .changeset -name "*.md" -not -name "README.md")" ]; then
            echo "::error::Pending changesets found! Please run 'pnpm changeset version' on staging before merging to main."
            exit 1
          fi

      - name: Setup Node.js 24
        uses: actions/setup-node@v6
        with:
          node-version: 24.12.0

      - name: Generate Release Summary
        run: node .github/scripts/generate-release-summary.mjs

      - name: Update PR Body
        run: |
          if [ -f RELEASE_SUMMARY.md ]; then
            SUMMARY_CONTENT=$(cat RELEASE_SUMMARY.md)
            gh pr edit ${{ github.event.pull_request.number }} --body "$SUMMARY_CONTENT"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release:
    name: Release
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js 24
        uses: actions/setup-node@v6
        with:
          node-version: 24.12.0
          registry-url: 'https://registry.npmjs.org'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.1+sha512.7d7dbbca9e99447b7c3bf7a73286afaaf6be99251eb9498baefa7d406892f67b879adb3a1d7e687fc4ccc1a388c7175fbaae567a26ab44d1067b54fcb0d6a316

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Kompo
        run: pnpm turbo run build

      - name: Remove local .npmrc for OIDC
        if: github.ref == 'refs/heads/main'
        run: rm -f .npmrc

      - name: Create Release Pull Request (Staging) or Publish (Main)
        id: changesets
        uses: changesets/action@v1
        with:
          version: pnpm release:version
          publish: ${{ github.ref == 'refs/heads/main' && 'pnpm release:publish' || '' }}
          commit: "chore: version packages"
          title: "Version Packages (Staging)"
          createGithubReleases: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Unified GitHub Release
        if: github.ref == 'refs/heads/main' && steps.changesets.outputs.published == 'true'
        run: |
          VERSION=$(node -p "require('./packages/cli/package.json').version")
          TAG="v$VERSION"
          
          # Git setup
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Push the tag
          git tag -f $TAG
          git push origin $TAG --force
          
          # 1. Generate our package-specific human notes
          node .github/scripts/generate-release-summary.mjs
          
          # 2. Generate GitHub's automatic notes (for Contributors/PR links)
          gh release notes $TAG --generate > GITHUB_NOTES.md
          
          # 3. Combine both: Package Summary + Contributors
          echo -e "$(cat RELEASE_SUMMARY.md)\n\n---\n\n$(cat GITHUB_NOTES.md)" > FINAL_RELEASE_NOTES.md
          
          # 4. Create release
          gh release delete $TAG --yes || true
          gh release create $TAG \
            --title "$TAG" \
            --notes-file FINAL_RELEASE_NOTES.md \
            --latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}