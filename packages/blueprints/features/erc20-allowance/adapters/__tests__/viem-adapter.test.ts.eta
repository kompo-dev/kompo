import { describe, it, expect, vi, beforeEach } from 'vitest'
import { createPublicClient, http } from 'viem'
import { mainnet } from 'viem/chains'
import { viemTokenAllowanceReader } from '../viem-<%= it.domain %>-adapter'
import type { TokenAllowanceReader } from '../../../domains/<%= it.domain %>/ports'

// Mock viem client
vi.mock('viem', () => ({
  createPublicClient: vi.fn(),
  http: vi.fn(),
}))

describe('Viem <%= it.pascalDomain %> Adapter', () => {
  let mockClient: any
  let tokenAllowanceReader: TokenAllowanceReader

  beforeEach(() => {
    // Setup mock client
    mockClient = {
      readContract: vi.fn(),
    }

    // Mock createPublicClient to return our mock
    vi.mocked(createPublicClient).mockReturnValue(mockClient)

    // Create the adapter
    tokenAllowanceReader = viemTokenAllowanceReader(mockClient as any)
  })

  describe('viemTokenAllowanceReader', () => {
    it('should read allowance from contract', async () => {
      // Arrange
      const expectedAllowance = 1000000n
      mockClient.readContract.mockResolvedValue(expectedAllowance)

      const input = {
        owner: '0x1234567890123456789012345678901234567890' as const,
        spender: '0x0987654321098765432109876543210987654321' as const,
        token: '0xabcdefabcdefabcdefabcdefabcdefabcdefabcd' as const,
      }

      // Act
      const result = await tokenAllowanceReader(input)

      // Assert
      expect(result).toBe(expectedAllowance)
      expect(mockClient.readContract).toHaveBeenCalledWith({
        address: input.token,
        abi: expect.any(Array), // ERC20 ABI
        functionName: 'allowance',
        args: [input.owner, input.spender],
      })
    })

    it('should handle contract read errors', async () => {
      // Arrange
      const error = new Error('Contract read failed')
      mockClient.readContract.mockRejectedValue(error)

      const input = {
        owner: '0x1234567890123456789012345678901234567890' as const,
        spender: '0x0987654321098765432109876543210987654321' as const,
        token: '0xabcdefabcdefabcdefabcdefabcdefabcdefabcd' as const,
      }

      // Act & Assert
      await expect(tokenAllowanceReader(input)).rejects.toThrow('Contract read failed')
    })

    it('should return zero allowance for non-existent contract', async () => {
      // Arrange
      mockClient.readContract.mockResolvedValue(0n)

      const input = {
        owner: '0x1234567890123456789012345678901234567890' as const,
        spender: '0x0987654321098765432109876543210987654321' as const,
        token: '0x0000000000000000000000000000000000000000' as const,
      }

      // Act
      const result = await tokenAllowanceReader(input)

      // Assert
      expect(result).toBe(0n)
    })
  })

  describe('createViemClient', () => {
    it('should create a client with http transport', async () => {
      const { createViemClient } = await import('../viem-<%= it.domain %>-adapter')
      
      // Act
      const client = createViemClient('https://mainnet.infura.io/v3/test')

      // Assert
      expect(createPublicClient).toHaveBeenCalledWith({
        transport: expect.any(Object), // http transport
      })
    })
  })
})
